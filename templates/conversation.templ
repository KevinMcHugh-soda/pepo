package templates

import "time"

type Conversation struct {
        ID          string    `json:"id"`
        PersonID    string    `json:"person_id"`
        OccurredAt  time.Time `json:"occurred_at"`
        Description string    `json:"description"`
        CreatedAt   time.Time `json:"created_at"`
        UpdatedAt   time.Time `json:"updated_at"`
       Themes      []Theme   `json:"themes"`
}

templ ConversationItem(conv Conversation) {
        <div class="border-b pb-3 mb-3" id={ "conversation-" + conv.ID }>
                <div class="flex justify-between items-start">
                        <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs text-gray-500 uppercase">Conversation</span>
                                        <span class="text-xs text-gray-500">{ conv.OccurredAt.Format("Jan 02, 2006 15:04") }</span>
                                </div>
                                <p class="text-gray-800 mb-1">{ conv.Description }</p>
                                if len(conv.Themes) > 0 {
                                       <div class="flex flex-wrap gap-1 mb-1">
                                               for _, theme := range conv.Themes {
                                                       <span class="inline-block bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full">{ theme.Text }</span>
                                               }
                                       </div>
                               }
                        </div>
                        <div class="space-x-2 ml-4">
                                <a
                                        href={ "/conversations/" + conv.ID + "/edit" }
                                        class="text-blue-500 hover:text-blue-700 text-sm"
                                >
                                        Edit
                                </a>
                                <button
                                        hx-delete={ "/api/v1/conversations/" + conv.ID }
                                        hx-target={ "#conversation-" + conv.ID }
                                        hx-swap="outerHTML"
                                        hx-confirm="Are you sure you want to delete this conversation?"
                                        class="text-red-500 hover:text-red-700 text-sm"
                                >
                                        Delete
                                </button>
                        </div>
                </div>
        </div>
}

templ ConversationList(conversations []Conversation) {
        if len(conversations) == 0 {
                <div class="text-gray-500 text-center py-4">No conversations found. Add some above!</div>
        } else {
                for _, c := range conversations {
                        @ConversationItem(c)
                }
        }
}

templ RecordConversationForm(personID string, targetSelector string) {
        <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Record New Conversation</h2>
                <form hx-post="/api/v1/conversations" hx-target={ targetSelector } hx-swap="afterbegin" hx-on::after-request="if(event.detail.successful) this.reset()" class="space-y-4">
                        if personID != "" {
                                <input type="hidden" name="person_id" value={ personID }/>
                        } else {
                                <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Person</label>
                                        <select
                                                name="person_id"
                                                id="conversation-person-select"
                                                required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                hx-get="/api/v1/people?format=select"
                                                hx-trigger="load"
                                                hx-target="#conversation-person-select"
                                                hx-swap="innerHTML"
                                                hx-on:change="htmx.ajax('GET', '/forms/actions/select?person_id=' + this.value, '#conversation-action-select'); htmx.ajax('GET', '/forms/themes/select?person_id=' + this.value, '#conversation-theme-select')"
                                        >
                                                <option value="">Loading people...</option>
                                        </select>
                                </div>
                        }
                        <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea
                                        name="description"
                                        required
                                        rows="2"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                ></textarea>
                        </div>
                        <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">When (optional)</label>
                                <input
                                        type="datetime-local"
                                        name="occurred_at"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                        </div>
                        <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Actions</label>
                                <select
                                        id="conversation-action-select"
                                        name="actions"
                                        multiple
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        if personID != "" {
                                                hx-get={ "/forms/actions/select?person_id=" + personID }
                                                hx-trigger="load"
                                                hx-target="#conversation-action-select"
                                                hx-swap="innerHTML"
                                        }
                                >
                                        if personID != "" {
                                                @ActionSelectLoading()
                                        } else {
                                                <option value="">Select a person first</option>
                                        }
                                </select>
                        </div>
                        <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Themes</label>
                                <select
                                        id="conversation-theme-select"
                                        name="themes"
                                        multiple
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        if personID != "" {
                                                hx-get={ "/forms/themes/select?person_id=" + personID }
                                                hx-trigger="load"
                                                hx-target="#conversation-theme-select"
                                                hx-swap="innerHTML"
                                        }
                                >
                                        if personID != "" {
                                                @ThemeSelectLoading()
                                        } else {
                                                <option value="">Select a person first</option>
                                        }
                                </select>
                                <div class="flex items-center gap-2 mt-2">
                                        <input
                                                type="text"
                                                id="conversation-new-theme-input"
                                                name="text"
                                                placeholder="Add new theme"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        />
                                        <button
                                                type="button"
                                                class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                hx-post="/forms/themes/create"
                                                hx-include="#conversation-new-theme-input,[name=person_id],#conversation-theme-select"
                                                hx-target="#conversation-theme-select"
                                                hx-swap="innerHTML"
                                                hx-on::after-request="if(event.detail.successful) document.getElementById('conversation-new-theme-input').value=''"
                                        >Add</button>
                                </div>
                        </div>
                        <div class="flex justify-end">
                                <button
                                        type="submit"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                        Save Conversation
                                </button>
                        </div>
                </form>
        </div>
}

templ RecordConversationPage(personID string) {
       @Layout("Record Conversation") {
               if personID != "" {
                       <a href={ "/people/" + personID } class="text-blue-600 hover:text-blue-800 flex items-center mb-4">
                               ← Back to Person
                       </a>
               } else {
                       <a href="/" class="text-blue-600 hover:text-blue-800 flex items-center mb-4">
                               ← Back to People List
                       </a>
               }
               @RecordConversationForm(personID, "#conversation-form-result")
               <div id="conversation-form-result" class="mt-4"></div>
       }
}

